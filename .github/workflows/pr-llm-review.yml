name: LLM PR Review

on:
  workflow_call:
    inputs:
      tenant:
        required: true
        type: string
        description: "StackSpot tenant identifier"
      client_id:
        required: true
        type: string
        description: "OAuth client ID"
      agent_id:
        required: true
        type: string
        description: "Agent identifier"
    secrets:
      CLIENT_SECRET:
        required: true
        description: "OAuth client secret"
      GITHUB_TOKEN:
        required: true
        description: "Github secret token to post comment on PR"

jobs:
  gather-context:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.diff.outputs.files }}
      diff: ${{ steps.diff.outputs.diff }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files and diffs
        id: diff
        continue-on-error: true
        run: |
          # Get list of changed files
          files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get the diff for all changed files (limit size if needed)
          diff=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          
          # Limit diff size to prevent issues with large changes
          if [ ${#diff} -gt 50000 ]; then
            diff="${diff:0:50000}... [TRUNCATED - diff too large]"
          fi
          
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  call-llm:
    needs: gather-context
    uses: ./.github/workflows/llm-prompt.yml
    with:
      tenant: ${{ inputs.tenant }}
      clientId: ${{ inputs.client_id }}
      conversationId: ${{ github.run_id }}-${{ github.run_number }}
      agentId: ${{ inputs.agent_id }}
      userPrompt: |
        Review the following pull request changes. 
        Starting with a summary and an in depth review for each file.
        
        Files changed:
        ${{ needs.gather-context.outputs.files }}

        Diff:
        ${{ needs.gather-context.outputs.diff }}

        Please provide a comprehensive code review focusing on:
        - Code quality and best practices
        - Potential bugs or issues
        - Security considerations
        - Performance implications
        - Suggestions for improvement
    secrets:
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}

  create-pr-comment:
    needs: [gather-context, call-llm]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download LLM Answers
        id: download-answers
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: llm-answers
          path: .

      - name: Create Pull Request Comment
        if: steps.download-answers.outcome == 'success'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "llm-response.txt" ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file llm-response.txt
          else
            gh pr comment ${{ github.event.pull_request.number }} --body "✅ LLM review completed but no response file found."
          fi

      - name: Handle failures gracefully
        if: failure() || needs.call-llm.result == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "⚠️ LLM PR Review workflow encountered issues but continuing..."
          gh pr comment ${{ github.event.pull_request.number }} --body "⚠️ LLM review encountered issues and was skipped for this PR."

      - name: Workflow Summary
        if: always()
        run: |
          echo "## LLM PR Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Context gathering: ${{ needs.gather-context.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- LLM call: ${{ needs.call-llm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Download answers: ${{ steps.download-answers.outcome }}" >> $GITHUB_STEP_SUMMARY